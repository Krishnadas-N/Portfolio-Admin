<div class="container mx-auto p-4 lg:p-8 max-w-5xl animate-fade-in">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
        <a routerLink="/testimonials" class="btn btn-circle btn-ghost text-text-tertiary hover:text-primary">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h1 class="text-2xl font-bold text-text-primary">{{ isEditMode ? 'Edit' : 'Add' }} Testimonial</h1>
    </div>

    <form [formGroup]="testimonialForm" (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Main Info -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Content Card -->
                <div class="glass-panel p-6 sm:p-8 rounded-2xl border border-border/50 bg-surface">
                    <h3 class="text-lg font-bold text-text-primary mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-pen-nib text-primary"></i> Content
                    </h3>

                    <div class="space-y-6">
                        <!-- Review Content -->
                        <div class="space-y-1.5">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Testimonial
                                *</label>
                            <textarea formControlName="content"
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all min-h-[150px] resize-y"
                                [class.border-error]="f['content'].touched && f['content'].invalid"
                                placeholder="What did the client say?"></textarea>
                            <span *ngIf="f['content'].touched && f['content'].invalid" class="text-xs text-error ml-1">
                                Content is required (min 10 chars)
                            </span>
                        </div>

                        <!-- Rating -->
                        <div class="space-y-1.5">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Rating
                                *</label>
                            <div class="flex gap-2">
                                <button type="button" *ngFor="let star of [1,2,3,4,5]" (click)="setRating(star)"
                                    class="text-2xl transition-transform hover:scale-110 focus:outline-none"
                                    [class.text-warning]="f['rating'].value >= star"
                                    [class.text-surface-elevated]="f['rating'].value < star">
                                    <i class="fa-solid fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Info Card -->
                <div class="glass-panel p-6 sm:p-8 rounded-2xl border border-border/50 bg-surface">
                    <h3 class="text-lg font-bold text-text-primary mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-user-tie text-secondary"></i> Client & Project Details
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Associated Project (Read-only for context) -->
                        <div class="md:col-span-2 space-y-1.5" *ngIf="projectTitle()">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Associated
                                Project</label>
                            <div
                                class="flex items-center gap-2 px-4 py-3 bg-surface-elevated/30 border border-border/60 rounded-xl text-text-primary">
                                <i class="fa-solid fa-cube text-primary"></i>
                                <span class="font-medium truncate">{{ projectTitle() }}</span>
                            </div>
                        </div>
                        <!-- Name -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Full
                                Name *</label>
                            <input type="text" formControlName="clientName" placeholder="e.g. John Doe"
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                        </div>

                        <!-- Company -->
                        <div class="space-y-1.5">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Company
                                *</label>
                            <input type="text" formControlName="clientCompany" placeholder="e.g. Tech Corp"
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                        </div>

                        <!-- Position -->
                        <div class="space-y-1.5 text-xs">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Position
                                *</label>
                            <input type="text" formControlName="clientPosition" placeholder="e.g. CEO"
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                        </div>

                        <!-- Email -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">Email
                                (Optional)</label>
                            <input type="email" formControlName="clientEmail" placeholder="client@example.com"
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                        </div>

                        <!-- LinkedIn -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label
                                class="text-xs font-semibold text-text-secondary uppercase tracking-wider ml-1">LinkedIn
                                Profile (Optional)</label>
                            <input type="text" formControlName="clientLinkedIn"
                                placeholder="https://linkedin.com/in/..."
                                class="w-full px-4 py-3 bg-surface-elevated/50 border border-border/60 rounded-xl text-text-primary placeholder:text-text-tertiary focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Image & Settings -->
            <div class="space-y-6">

                <!-- Settings -->
                <div class="glass-panel p-6 rounded-2xl border border-border/50 bg-surface">
                    <h3 class="text-xs font-bold text-text-tertiary uppercase tracking-widest mb-6">Visibility</h3>

                    <div class="space-y-4">
                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-between p-2 hover:bg-surface-elevated/50 rounded-lg transition-colors">
                                <span class="label-text font-medium text-text-primary">Active</span>
                                <input type="checkbox" formControlName="isActive"
                                    class="toggle toggle-success toggle-sm" />
                            </label>
                        </div>

                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-between p-2 hover:bg-surface-elevated/50 rounded-lg transition-colors">
                                <span class="label-text font-medium text-text-primary">Featured</span>
                                <input type="checkbox" formControlName="isFeatured"
                                    class="toggle toggle-secondary toggle-sm" />
                            </label>
                        </div>

                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-between p-2 hover:bg-surface-elevated/50 rounded-lg transition-colors">
                                <span class="label-text font-medium text-text-primary">Verified Client</span>
                                <input type="checkbox" formControlName="verified"
                                    class="toggle toggle-primary toggle-sm" />
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="glass-panel p-6 rounded-2xl border border-border/50 bg-surface">
                    <h3 class="text-xs font-bold text-text-tertiary uppercase tracking-widest mb-6">Client Photo</h3>

                    <div class="flex flex-col gap-4">
                        <div class="relative group cursor-pointer">
                            <!-- Preview -->
                            <div
                                class="w-32 h-32 mx-auto rounded-full overflow-hidden border-2 border-dashed border-border flex items-center justify-center bg-surface-elevated/30 hover:border-primary hover:bg-surface-elevated/50 transition-all relative">

                                <img *ngIf="f['clientImage'].value" [src]="f['clientImage'].value"
                                    class="w-full h-full object-cover" />

                                <div *ngIf="!f['clientImage'].value && !isUploading()"
                                    class="flex flex-col items-center text-text-tertiary">
                                    <i class="fa-solid fa-camera text-2xl mb-1"></i>
                                    <span class="text-[10px] uppercase">Upload</span>
                                </div>

                                <div *ngIf="isUploading()"
                                    class="absolute inset-0 flex items-center justify-center bg-black/50">
                                    <span class="loading loading-spinner text-primary"></span>
                                </div>

                                <input type="file" accept="image/*" (change)="onImageSelected($event)"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                            </div>

                            <!-- Remove Button -->
                            <button *ngIf="f['clientImage'].value" type="button" (click)="f['clientImage'].setValue('')"
                                class="absolute top-0 right-1/2 translate-x-16 btn btn-circle btn-xs btn-error text-white opacity-0 group-hover:opacity-100 transition-opacity shadow-md">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <div class="divider text-xs text-text-tertiary">OR URL</div>

                        <input type="text" formControlName="clientImage" placeholder="https://..."
                            class="w-full px-3 py-2 bg-surface-elevated/50 border border-border/60 rounded-lg text-text-primary text-xs focus:outline-none focus:ring-1 focus:ring-primary/20 focus:border-primary transition-all" />
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="flex gap-3 pt-4">
                    <button type="submit" [disabled]="isSubmitting() || testimonialForm.invalid"
                        class="btn btn-primary flex-1 shadow-lg shadow-primary/20">
                        <span *ngIf="isSubmitting()" class="loading loading-spinner loading-xs"></span>
                        {{ isEditMode ? 'Update' : 'Save' }} Testimonial
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>